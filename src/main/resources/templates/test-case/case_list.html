<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head th:replace="/fragment/commons :: common_header(~{::title},~{})">
        <title>TSIM @ CASE</title>
    </head>
    <body id="tsim_body" class="aside-enable">
        <div id="wrapper">
            <ul th:replace="/fragment/commons :: sidebarMenu(flag='case')"></ul>
            <div id="content-wrapper" class="d-flex flex-column">
                <div id="content">
                    <nav th:replace="/fragment/commons :: nav-on-main-top"></nav>
                    <div class="container-fluid">
                        <!--操作栏-->
                        <div class="pt-2 border-bottom">
                            <div class="card-body">
                                <div class="row">
                                    <div class="input-group mb-3" style="width:15%">
                                        <span class="input-group-text" id="basic-addon1">所属项目</span>
                                        <input type="text" class="form-control" name="projectId" id="p-search"
                                               placeholder="项目名称（模糊查询）" aria-label="projectId"
                                               aria-describedby="basic-addon1">
                                    </div>
                                    <div class="input-group mb-3 col-md-2" style="width:20%">
                                        <span class="input-group-text" id="basic-addon2">所属模块</span>
                                        <input type="text" class="form-control" name="moduleId"
                                               placeholder="模块名称（模糊查询）"
                                               aria-label="moduleId" id="m-search"
                                               aria-describedby="basic-addon2">
                                    </div>
                                    <div class="input-group mb-3 col-md-2" style="width:20%">
                                        <span class="input-group-text" id="basic-addon3">测试用例标题</span>
                                        <input type="text" class="form-control" name="name" placeholder="标题（模糊查询）"
                                               aria-label="name" id="name-search"
                                               aria-describedby="basic-addon3">
                                    </div>
                                    <select class="form-select mb-3 col-md-2" style="width:10%"
                                            aria-label="priority" name="priority" id="priority-search">
                                        <option th:value="' '" selected>测试用例优先级</option>
                                        <option value="0">低</option>
                                        <option value="1">中</option>
                                        <option value="2">高</option>
                                    </select>
                                    <select class="form-select mb-3 col-md-2" aria-label="active" name="active"
                                            id="active-search" style="width:11%">
                                        <option value="0">有效</option>
                                        <option value="1">无效</option>
                                    </select>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6">
                                    <button type="button" id="search-button" class="btn hvr-grow"><i
                                            class="bi bi-search"
                                            style="color: cornflowerblue"></i>
                                    </button>
                                    <button type="button" class="btn"
                                            data-bs-toggle="modal" data-bs-target="#add-case-modal"><i
                                            class="bi bi-plus-circle hvr-grow"
                                            style="color: cornflowerblue"></i>
                                    </button>
                                    <!--                                // 导出模板数据-->
                                    <a class="btn btn-light mb-3 mb-lg-0 hvr-grow"
                                       th:href="@{/case/download/test-case-template.xlsx}">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    <!--                                //导入数据-->
                                    <a class="btn btn-light mb-3 mb-lg-0 hvr-grow" data-bs-toggle="modal"
                                       data-bs-target="#uploadModal">
                                        <i class="bi bi-upload"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <!--            列表数据-->
                        <div id="table_refresh" th:fragment="table_refresh">
                            <table id="table" class="table table-hover">
                            </table>
                        </div>
                        <!--        分页-->
                        <!--                        <div th:replace="/fragment/commons :: pagination01"></div>-->
                    </div>
                </div>
                <footer th:replace="/fragment/commons :: footer"></footer>
            </div>
        </div>

        <!-- 添加问题单Modal弹框 -->
        <div th:replace="~{test-case/add_case_modal::addCaseFragment}"></div>
        <div th:replace="~{test-case/detailModal::caseDetailFragment}"></div>
        <div th:replace="~{test-case/editModal::caseEditFragment}"></div>
        <div th:replace="~{test-case/uploadCase::uploadModal}"></div>
        <!--                    toast-->
        <div th:replace="/fragment/commons :: toast-div"></div>
        <!-- Logout Modal-->
        <div th:replace="/fragment/commons :: logout"></div>
        <script type="text/javascript" th:src="@{/plugins/jquery-3.6.0.min.js}"></script>
        <script type="text/javascript" th:src="@{/bootstrap/js/bootstrap.bundle.min.js}"></script>
        <script type="text/javascript" th:src="@{/plugins/bst/bootstrap-table.js}"></script>
        <script type="text/javascript" th:src="@{/plugins/bst/bootstrap-table-zh-CN.js}"></script>
        <script type="text/javascript" th:src="@{/global/js/bs.table.js}"></script>
        <script type="text/javascript" th:src="@{/plugins/autocomplete.js}"></script>
        <script type="text/javascript" th:src="@{/global/js/common.js}"></script>
        <script type="text/javascript" th:src="@{/global/js/add-case.js}"></script>
        <script th:inline="javascript">
            $(document).on('click', "#search-button", function () {
                $('#table').bootstrapTable('refresh');

            });
            const _table_columns = [
                {field: 'id', align: 'center', title: 'id', visible: false}, {
                    field: 'projectId',
                    align: 'center',
                    title: '所属项目',
                    class: 'col-sm-4',
                    formatter: function (value, row, index) {
                        return row.project.projectName;
                    }
                }, {
                    field: 'moduleId',
                    align: 'center',
                    title: '所属模块',
                    class: 'col-sm-4',
                    formatter: function (value, row, index) {
                        return row.module.moduleName;
                    }
                }, {
                    field: 'name',
                    align: 'center',
                    title: '测试用例标题',
                    class: 'col-sm-6'
                }, {
                    field: 'description',
                    align: 'center',
                    title: '测试用例描述',
                    class: 'col-sm-6'
                },
                {
                    field: 'precondition',
                    align: 'center',
                    title: '前置条件',
                    class: 'col-sm-6'
                },
                {
                    field: 'stepStore',
                    align: 'center',
                    title: '测试用例步骤',
                    class: 'col-sm-6',
                    formatter: stepFormatter
                },
                {
                    field: 'resultStore',
                    align: 'center',
                    title: '预期结果',
                    class: 'col-sm-6',
                    formatter: stepResultFormatter
                },
                {
                    field: 'priority',
                    align: 'center',
                    title: '优先级',
                    class: 'col-sm-2',
                    formatter: function (value, row, index) {
                        let _priority = '';
                        switch (value) {
                            case 1:
                                _priority = "低";
                                break
                            case 2:
                                _priority = "中";
                                break
                            case 3:
                                _priority = "高";
                                break
                        }
                        return _priority;
                    }
                },
                {title: '操作', align: 'center', field: 'id', class: 'col-sm-2', formatter: option,}]

            function option(value, row, index) {
                // return "<a href='#' id='del-project' onclick='delPro(" + row.id + ")' title='删除'>删除</a>";
                const d = '<button class="btn btn-sm-c btn-outline-info" data-bs-toggle="modal" data-bs-target="#case-detail-modal" onclick="detailCase(\'' + row.id + '\')">查看</button>';
                const e = '<button disabled class="btn btn-sm-c btn-outline-info" data-bs-toggle="modal" data-bs-target="#case-edit-modal" onclick="editCase(\'' + row.id + '\')">编辑</button>'
                return e + d;
            }

            //测试步骤封装
            function stepFormatter(value, row, index) {
                const stepJsonArray = JSON.parse(row.stepStore);
                let step_result = '';
                for (let i = 0; i < stepJsonArray.length; i++) {
                    const temp_step_json = JSON.parse(JSON.stringify(stepJsonArray[i]));
                    const tempStepJsonElement = JSON.stringify(temp_step_json[i]);
                    const map1 = eval("(" + tempStepJsonElement + ")");
                    step_result = step_result + map1.t_s + "\r\n";
                }
                return step_result;
            }

            // 预期结果封装
            function stepResultFormatter(value, row, index) {
                const stepJsonArray = JSON.parse(row.stepStore);
                let step_result = '';
                for (let i = 0; i < stepJsonArray.length; i++) {
                    const temp_step_json = JSON.parse(JSON.stringify(stepJsonArray[i]));
                    const tempStepJsonElement = JSON.stringify(temp_step_json[i]);
                    const map1 = eval("(" + tempStepJsonElement + ")");
                    step_result = step_result + map1.t_r + "\r\n";
                }
                return step_result;
            }

            //查看测试用例数据
            function detailCase(id) {
                $('#case-detail-modal').on('shown.bs.modal', function () {
                    $.ajax({
                            url: '/case/queryCase/',
                            type: 'post',
                            data: JSON.stringify({
                                id: id,
                            }),
                            dataType: 'JSON',
                            // contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                            success: function (arg) {
                                $("#projectCode-d").val(arg['data'].project.projectName);
                                $("#moduleId-d").val(arg['data'].module.moduleName);
                                $("#caseTitle-d").val(arg['data'].name);
                                $("#description-d").val(arg['data'].description);
                                $("#precondition-d").val(arg['data'].precondition);
                                let _priority = "";
                                switch (arg['data'].priority) {
                                    case 0:
                                        _priority = "低";
                                        break
                                    case 1:
                                        _priority = "中";
                                        break
                                    case 2:
                                        _priority = "高";
                                        break
                                }
                                $("#priority-d").val(_priority);
                                let _testMode = "";
                                switch (arg['data'].testMode) {
                                    case 0:
                                        _testMode = "手动";
                                        break
                                    case 1:
                                        _testMode = "自动";
                                        break
                                }
                                $("#testMode-d").val(_testMode);
                                // 填充测试步骤
                                loadStepAndResult(arg);
                            }
                        }
                    )
                })
            }

            function loadStepAndResult(arg) {
                $('#step-result > tbody').html("");
                const tbody = $('#step-result').find('tbody');
                const stepResults = arg['data'].caseSteps;
                for (let i = 0; i < stepResults.length; i++) {
                    const _temp = stepResults[i];
                    const new_tr = $("<tr></tr>")
                    const _id = _temp.id;
                    const hiddenInput = $("<input name='id' id='id' type='hidden' value='" + _id + "'>");
                    new_tr.append(hiddenInput);
                    const _order = _temp.caseOrder;
                    const order = $("<input name='caseOrder' id='caseOrder' type='hidden' value='" + _order + "'>");
                    new_tr.append(order);
                    const step_td = $("<td></td>")
                    const _step = _temp.caseStep;
                    step_td.text(_step);
                    new_tr.append(step_td);
                    const res_td = $("<td></td>")
                    const _result = _temp.caseStepResult;
                    res_td.text(_result)
                    new_tr.append(res_td);
                    tbody.append(new_tr);
                }
            }

            //todo 编辑测试用例
            function editCase(id) {
                $('#case-edit-modal').on('shown.bs.modal', function () {
                    $.ajax({
                            url: '/case/queryCase/',
                            type: 'post',
                            data: JSON.stringify({
                                id: id,
                            }),
                            dataType: 'JSON',
                            // contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                            success: function (arg) {
                                $("#hidden-project-id").val(arg['data'].project.id);
                                $("#edit-case-project-name").val(arg['data'].project.projectName);
                                $("#hidden-module-id").val(arg['data'].moduleId);
                                $("#edit-case-module-name").val(arg['data'].module.moduleName);
                                $("#edit-case-title").val(arg['data'].name);
                                $("#edit-case-description").val(arg['data'].description);
                                $("#edit-case-precondition").val(arg['data'].precondition);
                                let _priority = "";
                                switch (arg['data'].priority) {
                                    case 0:
                                        _priority = "低";
                                        break
                                    case 1:
                                        _priority = "中";
                                        break
                                    case 2:
                                        _priority = "高";
                                        break
                                }
                                $("#edit-case-priority").val(_priority);
                                let _testMode = "";
                                switch (arg['data'].testMode) {
                                    case 0:
                                        _testMode = "手动";
                                        break
                                    case 1:
                                        _testMode = "自动";
                                        break
                                }
                                $("#edit-case-testMode").val(_testMode);
                                // 填充测试步骤
                                const stepResults = arg['data'].caseSteps;
                                function responseHandler(stepResults) {
                                    return JSON.parse(stepResults)
                                }

                            }
                        }
                    )
                })
            }

            // 查询条件
            const _search_params = function (params) {
                return {
                    projectName: $('#p-search').val().trim(), // 自定义查询条件
                    moduleName: $('#m-search').val().trim(), // 自定义查询条件
                    caseName: $('#name-search').val().trim(), // 自定义查询条件
                    pageSize: params.limit,
                    pageNum: params.offset / params.limit + 1,

                }
            };
            InitTable('/case/reloadTable', 'get', _table_columns, _search_params);

            autoComplete("/project/queryList", "p-search", 'p', false);

            $('#add-case-modal').on('shown.bs.modal', function (event) {
                autoComplete("/project/queryList", "projectId", 'p', true);
                // myModal.off('shown.bs.modal');//去除绑定
            });
            // 查询相关关联的模块
            $("#moduleId")[0].addEventListener("focus", function () {
                autoComplete("/module/queryList/" + $("#c-a-p").attr("value"), "moduleId", 'm', false);
            });
            $("#case-story")[0].addEventListener("focus", function () {
                autoComplete("/story/queryList/" + $("#c-a-p").attr("value"), "case-story", 's', true);
            });

        </script>
    </body>
</html>
